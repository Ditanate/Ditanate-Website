<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat | Ditanate</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        :root {
            --bg: #0f0f13;
            --accent: #ff9d00;
            --glass: rgba(255, 255, 255, 0.05);
            --error: #ff4444;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f13 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden; /* –ß—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–µ –≤—ã–∑—ã–≤–∞–ª–æ —Å–∫—Ä–æ–ª–ª */
        }

        .back-hub {
            position: absolute; top: 20px; left: 20px; color: #666;
            text-decoration: none; font-size: 0.8rem; text-transform: uppercase; transition: 0.3s;
        }
        .back-hub:hover { color: var(--accent); }

        .login-card, .chat-card {
            background: var(--glass); padding: 40px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05); text-align: center;
            width: 100%; max-width: 400px; backdrop-filter: blur(10px);
        }

        .chat-card { display: none; max-width: 700px; height: 85vh; flex-direction: column; position: relative; }
        
        /* –ü–∞–Ω–µ–ª—å –∑–∞–∫—Ä–µ–ø–∞ */
        #pin-panel {
            background: rgba(255, 157, 0, 0.1); border-left: 4px solid var(--accent);
            padding: 10px; margin-bottom: 10px; text-align: left; display: none;
            font-size: 0.85rem; cursor: pointer;
        }

        #msgs { flex: 1; overflow-y: auto; text-align: left; margin: 10px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        
        .msg { margin-bottom: 10px; font-size: 0.9rem; padding: 5px; border-radius: 5px; transition: background 0.2s; }
        .msg:hover { background: rgba(255,255,255,0.05); }
        .msg b { color: var(--accent); cursor: pointer; }

        h1 { font-size: 1.5rem; letter-spacing: 2px; margin-bottom: 10px; }
        p { color: #666; font-size: 0.9rem; margin-bottom: 30px; }

        .input-group { text-align: left; margin-bottom: 15px; }

        input {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; color: white; box-sizing: border-box;
        }
        input:focus { border-color: var(--accent); outline: none; }
        
        .error-text { color: var(--error); font-size: 0.75rem; margin-top: 5px; display: none; }

        .btn {
            width: 100%; padding: 12px; background: var(--accent); border: none;
            border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; color: black; margin-top: 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,157,0,0.3); }

        /* –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –í–´–•–û–î–ê */
        .logout-btn {
            width: 100%; padding: 15px; margin-top: 15px;
            background: transparent; border: 2px solid #333; color: #666;
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            border-radius: 10px; cursor: pointer; transition: all 0.4s ease;
        }
        .logout-btn:hover {
            border-color: var(--error); color: var(--error);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.2);
            text-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
        }

        /* –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ */
        #context-menu {
            position: fixed; display: none; background: #15151e; border: 1px solid #333;
            border-radius: 8px; z-index: 1000; width: 200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); overflow: hidden;
        }
        .ctx-item {
            padding: 12px 20px; cursor: pointer; font-size: 0.9rem;
            color: #ddd; transition: 0.2s; text-align: left; display: flex; justify-content: space-between;
        }
        .ctx-item:hover { background: var(--accent); color: #000; }
        .ctx-divider { height: 1px; background: #333; margin: 0; }
        .ctx-red:hover { background: var(--error); color: white; }

        .footer-note { font-size: 0.7rem; color: #444; margin-top: 20px; }
    </style>
</head>
<body>

    <a href="https://ditanate.pro" class="back-hub">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ HUB</a>

    <div id="login-box" class="login-card">
        <h1>DITANATE PRIVATE</h1>
        <p>–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Ü</p>
        
        <form onsubmit="event.preventDefault(); login();">
            <div class="input-group">
                <input type="text" id="user" name="username" placeholder="Username" autocomplete="username">
                <div id="user-error" class="error-text">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            </div>

            <div class="input-group">
                <input type="password" id="pass" name="password" placeholder="Password" autocomplete="current-password">
                <div id="pass-error" class="error-text">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</div>
            </div>

            <button type="submit" class="btn">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
        </form>

        <div id="general-error" class="error-text" style="text-align:center; margin-top:10px;"></div>

        <div class="footer-note">
            –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Ö–æ–¥–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å Ditanate.<br>
            ¬© 2026 Ditanate. Protected area. All rights reserved.
        </div>
    </div>

    <div id="chat-box" class="chat-card">
        <h1>PRIVATE CHAT</h1>
        
        <div id="pin-panel" onclick="unpinMsg()">
            <div style="font-weight:bold; color:var(--accent)">üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
            <div id="pin-content" style="color:#ddd; margin-top:2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">...</div>
        </div>

        <div id="msgs">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
        
        <div style="display:flex; gap: 10px;">
            <input type="text" id="msg-text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="checkEnter(event)">
            <button onclick="send()" class="btn" style="width: 80px; margin:0;">‚Üí</button>
        </div>
        
        <button onclick="logout()" class="logout-btn">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>

    <div id="context-menu">
        <div class="ctx-item" onclick="replyMsg()">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="ctx-item" onclick="copyMsg()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div id="admin-tools" style="display:none">
            <div class="ctx-divider"></div>
            <div class="ctx-item" onclick="pinMsg()">üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
            <div class="ctx-item ctx-red" onclick="deleteMsg()">üóë –£–¥–∞–ª–∏—Ç—å</div>
        </div>
    </div>

    <script>
        const SS_URL = "https://script.google.com/macros/s/AKfycbyxh_BST2b-gX5ANLXYo7nPGrAH6xWB-uXmZjWPaMId0CCrTWmV7GTOWsXeuKkVvNTV/exec";
        
        // –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const notifSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3'); 

        let currentUser = localStorage.getItem('ditanate_user');
        let isAdmin = localStorage.getItem('ditanate_role') === 'admin';
        
        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        let selectedMsgText = "";
        let selectedMsgAuthor = "";
        let selectedMsgId = -1;

        // –ê–≤—Ç–æ-–≤—Ö–æ–¥
        if(currentUser) {
            initChat();
        }

        async function login() {
            const userInp = document.getElementById('user');
            const passInp = document.getElementById('pass');
            const genErr = document.getElementById('general-error');

            genErr.style.display = 'none';

            if(!userInp.value || !passInp.value) return;

            try {
                // –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Ä–≤–µ—Ä)
                // –ï—Å–ª–∏ —Ç—ã –≤—Ö–æ–¥–∏—à—å –∫–∞–∫ Ditanate - —Ç—ã —Å—Ä–∞–∑—É –ê–¥–º–∏–Ω
                const isLocalAdmin = userInp.value.toLowerCase() === 'ditanate';

                const response = await fetch(SS_URL, {
                    method: 'POST',
                    body: JSON.stringify({type: "login", user: userInp.value, pass: passInp.value})
                });
                const data = await response.json();

                if (data.res === "ok") {
                    currentUser = userInp.value;
                    isAdmin = isLocalAdmin; // –ò–ª–∏ data.role –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω–µ—Ç
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Cookie (LocalStorage)
                    localStorage.setItem('ditanate_user', currentUser);
                    if(isAdmin) localStorage.setItem('ditanate_role', 'admin');

                    initChat();
                } else {
                    genErr.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!";
                    genErr.style.display = 'block';
                }
            } catch (e) {
                genErr.innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!";
                genErr.style.display = 'block';
            }
        }

        function initChat() {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('chat-box').style.display = 'flex';
            if(isAdmin) document.getElementById('admin-tools').style.display = 'block';
            loadMessages();
            setInterval(loadMessages, 5000);
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        function checkEnter(e) {
            if(e.key === "Enter") send();
        }

        async function send() {
            const input = document.getElementById('msg-text');
            const text = input.value.trim();
            if(!text) return;

            // –õ–æ–≥–∏–∫–∞ MUTE
            if(text.startsWith('/mute')) {
                if(!isAdmin) { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤!"); return; }
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –µ–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å)
                input.value = "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã...";
            } else {
                input.value = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
            }
            
            await fetch(SS_URL, {
                method: 'POST',
                body: JSON.stringify({type: "send", user: currentUser, text: text})
            });
            input.value = "";
            loadMessages();
        }

        async function loadMessages() {
            const res = await fetch(SS_URL);
            const data = await res.json();
            const box = document.getElementById('msgs');
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ü–ö–ú (contextmenu)
            box.innerHTML = data.map((m, idx) => `
                <div class="msg" oncontextmenu="openCtxMenu(event, '${m[1]}', '${m[0]}', ${idx})">
                    <b>${m[0]}:</b> ${m[1]} 
                    <i style="font-size:10px; color:#444; margin-left:5px">${new Date(m[2]).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</i>
                </div>
            `).join('');
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –≤–Ω–∏–∑—É
            // box.scrollTop = box.scrollHeight; 
        }

        // --- CONTEXT MENU LOGIC ---
        function openCtxMenu(e, text, author, id) {
            e.preventDefault();
            selectedMsgText = text;
            selectedMsgAuthor = author;
            selectedMsgId = id;

            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
        document.addEventListener('click', () => {
            document.getElementById('context-menu').style.display = 'none';
        });

        function copyMsg() {
            navigator.clipboard.writeText(selectedMsgText);
        }

        function replyMsg() {
            const inp = document.getElementById('msg-text');
            inp.value = `@${selectedMsgAuthor}, ` + inp.value;
            inp.focus();
            notifSound.volume = 0.5;
            notifSound.play().catch(e => console.log('Audio error', e));
        }

        function pinMsg() {
            if(!isAdmin) return;
            document.getElementById('pin-panel').style.display = 'block';
            document.getElementById('pin-content').innerText = `${selectedMsgAuthor}: ${selectedMsgText}`;
            // –í –∏–¥–µ–∞–ª–µ —Ç—É—Ç –Ω—É–∂–µ–Ω fetch –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫—Ä–µ–ø
        }
        
        function unpinMsg() {
            if(isAdmin && confirm("–û—Ç–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
                document.getElementById('pin-panel').style.display = 'none';
            }
        }

        function deleteMsg() {
            if(!isAdmin) return;
            if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —É –≤—Å–µ—Ö?")) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
                fetch(SS_URL, {
                    method: 'POST',
                    body: JSON.stringify({type: "delete", user: currentUser, id: selectedMsgId})
                }).then(() => {
                    loadMessages();
                    alert("–ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.");
                });
            }
        }
    </script>
</body>
</html>



